<html>
  <title>UDP Display</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <link rel="stylesheet" href="https://www.w3schools.com/lib/w3-theme-dark-grey.css">
  <script src="../echarts-5.5.1/dist/echarts.js"></script>
  <script src="mytheme.js"></script>
<style>
  body {
    background-color: black
  }
</style>
<head>
  <title>ex1 echarts</title>

  <script type="text/javascript">

    var ws;
    
    var update_list;
    var next_time = -9999.0;
    const UPDATE_RATE = 0.02;

    var my_chart;

    function updateElement(x, data) {
      // update the object x with the corresponding value
      // from the full json data
      let val = data[x.id][0]
      let sep = " = "
      if (val >= 0) {
        sep += "&nbsp"
      }
      let n = 4;
      if (x.id == "time") { n = 2; }
      x.innerHTML = x.id + sep + val.toFixed(n)

      if (x.id == "time") {
        return;
      }

      if (val < -0.9 & !x.classList.contains("w3-blue")) {
        x.classList.add("w3-blue");
      } else if (val > -0.9 & x.classList.contains("w3-blue")) {
        x.classList.remove("w3-blue");
      }
      if (val > 0.9 & !x.classList.contains("w3-red")) {
        x.classList.add("w3-red");
      } else if (val < 0.9 & x.classList.contains("w3-red")) {
        x.classList.remove("w3-red");
      }
    }

    var my_chart;
    var option;
    function init() {
      // get list of cells to update
      //update_list = Array.from(document.getElementsByClassName("mydata"));

      // Connect to Web Socket
      ws = new WebSocket("ws://localhost:41953/");

      // Set event handlers.
      ws.onopen = function() {
        console.log("ws.onopen");
      }
      
      ws.onmessage = function(e) {
        // e.data contains received string.
        data = JSON.parse(e.data);
        option.series[0].data.shift();
        option.series[0].data.push([ data["time"][0], data["x001"][0] ]);
        option.xAxis.max = data["time"][0];
        option.xAxis.min = option.xAxis.max - 20;
        if (data["time"][0] > next_time) {
          next_time = data["time"][0] + UPDATE_RATE;
          my_chart.setOption(option);
        //  update_list.forEach((value, index, array) => updateElement(value, data));
        }
      }
      
      ws.onerror = function(e) {
        output("onerror");
        console.log(e);
      }

      my_chart = echarts.init(document.getElementById('main'), 'mytheme');
      option = {
        animationDurationUpdate: 100,
        title: {
          text: "A title"
        },
        tooltip: {},
        xAxis: {},
        yAxis: {min: -1.2, max: 1.2},
        series: [
          {
            data: Array(6000).fill( [NaN, NaN] ),
            type: 'line'
          }
        ]
      };
      my_chart.setOption(option);
    }
    
    function onCloseClick() {
      ws.close();
    }
    
  </script>
</head>
<body class="w3-monospace w3-theme-dark" onload="init();">
  <div id="main" style="width: 600px; height: 400px;"></div>
</body>
</html>